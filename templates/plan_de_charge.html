{% extends "base.html" %}
{% set default_sites = [
  "Site A",
  "Site B",
  "Site C",
  "Site D",
  "Site E",
  "Site F",
  "Site G",
  "Site H"
] %}
{% block title %}Plan de charge ‚Äî CRM Local{% endblock %}
{% block page_eyebrow %}Pilotage des op√©rations{% endblock %}
{% block page_title %}Plan de charge{% endblock %}
{% block page_subtitle %}Pr√©visualisez et ajustez la charge des √©quipes terrain sur 52 semaines, importez ou exportez vos donn√©es et visualisez l'√©tat de chaque site en un clin d'≈ìil.{% endblock %}
{% block head_extra %}
  <style>
    :root {
      color-scheme: light;
      --cell-w: 28px;
      --cell-h: 40px;
      --workload-shell-bg: radial-gradient(circle at 20% 20%, rgba(129, 140, 248, 0.12), transparent 45%),
        radial-gradient(circle at 80% 0%, rgba(56, 189, 248, 0.1), transparent 55%),
        linear-gradient(145deg, rgba(255, 255, 255, 0.96), rgba(241, 245, 249, 0.94));
      --workload-shadow: 0 32px 80px -40px rgba(15, 23, 42, 0.25);
      --workload-overlay-border: rgba(148, 163, 184, 0.18);
      --workload-fg: #0f172a;
      --workload-muted: #64748b;
      --workload-sep: rgba(226, 232, 240, 0.8);
      --workload-focus: rgba(59, 130, 246, 0.6);
      --workload-focus-ring: rgba(59, 130, 246, 0.25);
      --workload-input-bg: rgba(255, 255, 255, 0.9);
      --workload-input-border: rgba(148, 163, 184, 0.45);
      --workload-toolbar-bg: linear-gradient(180deg, rgba(255, 255, 255, 0.96), rgba(241, 245, 249, 0.85) 65%, rgba(241, 245, 249, 0));
      --workload-badge-border: rgba(148, 163, 184, 0.4);
      --workload-badge-bg: rgba(226, 232, 240, 0.7);
      --workload-grid-bg: rgba(248, 250, 252, 0.85);
      --workload-header-bg: rgba(255, 255, 255, 0.92);
      --workload-header-week-color: rgba(15, 23, 42, 0.78);
      --workload-header-day-color: rgba(30, 41, 59, 0.7);
      --workload-headsite-bg: linear-gradient(90deg, rgba(255, 255, 255, 0.96), rgba(241, 245, 249, 0.88));
      --workload-site-row-bg: rgba(255, 255, 255, 0.95);
      --workload-site-row-alt-bg: rgba(241, 245, 249, 0.95);
      --workload-cell-border: rgba(148, 163, 184, 0.55);
      --workload-cell-bg: rgba(255, 255, 255, 0.96);
      --workload-cell-hover-border: rgba(59, 130, 246, 0.6);
      --workload-week-divider: rgba(148, 163, 184, 0.45);
      --workload-btn-bg: rgba(255, 255, 255, 0.95);
      --workload-btn-hover-bg: rgba(241, 245, 249, 0.95);
      --workload-btn-border: rgba(148, 163, 184, 0.45);
      --workload-btn-text: #0f172a;
      --workload-toast-bg: rgba(15, 23, 42, 0.92);
      --workload-toast-border: rgba(148, 163, 184, 0.4);
      --workload-toast-color: #f8fafc;
      --workload-mark-bg: rgba(96, 165, 250, 0.22);
      --workload-ok: #16a34a;
      --workload-warn: #f97316;
      --workload-bad: #dc2626;
      --workload-ok-bg: rgba(22, 163, 74, 0.12);
      --workload-ok-border: rgba(22, 163, 74, 0.4);
      --workload-ok-dashed: rgba(22, 163, 74, 0.45);
      --workload-warn-bg: rgba(251, 146, 60, 0.12);
      --workload-warn-border: rgba(251, 146, 60, 0.45);
      --workload-bad-bg: rgba(220, 38, 38, 0.12);
      --workload-bad-border: rgba(220, 38, 38, 0.5);
    }

    html.dark {
      color-scheme: dark;
      --workload-shell-bg: radial-gradient(circle at 20% 20%, rgba(99,102,241,0.18), transparent 45%),
        radial-gradient(circle at 80% 0%, rgba(56,189,248,0.15), transparent 55%),
        linear-gradient(145deg, rgba(11,16,32,0.96), rgba(17,24,39,0.94));
      --workload-shadow: 0 32px 80px -40px rgba(79, 70, 229, 0.45);
      --workload-overlay-border: rgba(148, 163, 184, 0.15);
      --workload-fg: #e5e7eb;
      --workload-muted: #9ca3af;
      --workload-sep: #1f2937;
      --workload-focus: rgba(96, 165, 250, 0.6);
      --workload-focus-ring: rgba(96, 165, 250, 0.25);
      --workload-input-bg: rgba(10,15,26,0.8);
      --workload-input-border: rgba(148, 163, 184, 0.25);
      --workload-toolbar-bg: linear-gradient(180deg, rgba(17,24,39,0.96), rgba(17,24,39,0.82) 65%, rgba(17,24,39,0));
      --workload-badge-border: rgba(148, 163, 184, 0.25);
      --workload-badge-bg: rgba(15, 23, 42, 0.55);
      --workload-grid-bg: rgba(11, 18, 36, 0.85);
      --workload-header-bg: rgba(11,16,32,0.9);
      --workload-header-week-color: rgba(226,232,240,0.85);
      --workload-header-day-color: rgba(226,232,240,0.75);
      --workload-headsite-bg: linear-gradient(90deg, rgba(11,16,32,0.96), rgba(11,16,32,0.85));
      --workload-site-row-bg: rgba(12, 19, 37, 0.95);
      --workload-site-row-alt-bg: rgba(13, 20, 41, 0.95);
      --workload-cell-border: rgba(55, 65, 81, 0.8);
      --workload-cell-bg: rgba(9, 14, 23, 0.9);
      --workload-cell-hover-border: rgba(96, 165, 250, 0.6);
      --workload-week-divider: rgba(148, 163, 184, 0.35);
      --workload-btn-bg: rgba(9,14,23,0.9);
      --workload-btn-hover-bg: rgba(15,23,42,0.9);
      --workload-btn-border: rgba(148, 163, 184, 0.3);
      --workload-btn-text: #e5e7eb;
      --workload-toast-bg: rgba(9,14,23,0.95);
      --workload-toast-border: rgba(148,163,184,0.35);
      --workload-toast-color: #e5e7eb;
      --workload-mark-bg: rgba(96, 165, 250, 0.22);
      --workload-ok-bg: rgba(22, 163, 74, 0.18);
      --workload-ok-border: rgba(22, 163, 74, 0.55);
      --workload-ok-dashed: rgba(22, 163, 74, 0.55);
      --workload-warn-bg: rgba(251, 146, 60, 0.18);
      --workload-warn-border: rgba(251, 146, 60, 0.55);
      --workload-bad-bg: rgba(220, 38, 38, 0.18);
      --workload-bad-border: rgba(220, 38, 38, 0.6);
    }

    .workload-shell {
      --left-col-w: 340px;
      /*
        Espacements internes de la grille :
        - --col-gap : faible interstice de 2px entre les jours pour garder les colonnes lisibles sans trop √©largir la vue.
        - --head-body-gap : marge verticale de 6px exclusivement entre l'en-t√™te des jours (L M M J V S D) et la toute premi√®re ligne de sites afin d'√©viter leur recouvrement.
      */
      --col-gap: 2px;
      --head-body-gap: 6px;
      --toolbar-h: 54px;
      --week-h: 40px;
      --day-h: 32px;
      position: relative;
      border-radius: 1.75rem;
      background: var(--workload-shell-bg);
      color: var(--workload-fg);
      box-shadow: var(--workload-shadow);
      overflow: hidden;
      transition: background 0.4s ease, color 0.3s ease, box-shadow 0.3s ease;
    }

    .workload-shell::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      border-radius: inherit;
      border: 1px solid var(--workload-overlay-border);
      transition: border-color 0.3s ease;
    }

    .workload-app {
      display: flex;
      flex-direction: column;
      min-height: 720px;
      font: 14px/1.4 "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    .workload-app *,
    .workload-app *::before,
    .workload-app *::after {
      box-sizing: border-box;
    }

    .workload-shell .toolbar {
      position: sticky;
      top: 0;
      z-index: 5;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
      padding: 14px 18px;
      background: var(--workload-toolbar-bg);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--workload-sep);
      min-height: var(--toolbar-h);
      transition: background 0.3s ease, border-color 0.3s ease;
    }

    .workload-shell .toolbar label {
      font-size: 12px;
      color: var(--workload-muted);
      margin-right: 6px;
      white-space: nowrap;
      transition: color 0.3s ease;
    }

    .workload-shell .toolbar .actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .workload-shell .toolbar .grow {
      flex: 1;
      min-width: 120px;
    }

    .workload-shell .toolbar input[type="text"],
    .workload-shell .toolbar select {
      background: var(--workload-input-bg);
      color: var(--workload-fg);
      border: 1px solid var(--workload-input-border);
      border-radius: 10px;
      padding: 6px 10px;
      height: 32px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, color 0.2s ease;
    }

    .workload-shell .toolbar input[type="text"]:focus,
    .workload-shell .toolbar select:focus {
      outline: none;
      border-color: var(--workload-focus);
      box-shadow: 0 0 0 2px var(--workload-focus-ring);
    }

    .workload-shell .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--workload-badge-border);
      border-radius: 999px;
      padding: 5px 12px;
      font-size: 12px;
      background: var(--workload-badge-bg);
      transition: background 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }

    .workload-shell .badge .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      background: var(--workload-ok);
    }

    .workload-shell .wrap {
      position: relative;
      overflow: auto;
      flex: 1;
    }

    .workload-shell .grid {
      display: grid;
      grid-template-columns: var(--left-col-w) repeat(364, var(--cell-w));
      grid-auto-rows: minmax(var(--cell-h), auto);
      column-gap: var(--col-gap);
      row-gap: 0; /* Aucun espacement automatique entre les lignes de sites. */
      padding: 16px;
      min-width: max(100%, calc(var(--left-col-w) + (var(--cell-w) + var(--col-gap)) * 364));
      background: var(--workload-grid-bg);
      transition: background 0.3s ease;
    }

    .workload-shell .grid .header {
      position: sticky;
      z-index: 3;
      background: var(--workload-header-bg);
      backdrop-filter: blur(6px);
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      transition: background 0.3s ease;
    }

    .workload-shell .grid .header-wk {
      top: var(--toolbar-h);
      height: var(--week-h);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--workload-header-week-color);
      transition: color 0.3s ease;
    }

    .workload-shell .grid .header-day {
      top: calc(var(--toolbar-h) + var(--week-h) + var(--row-gap));
      height: var(--day-h);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--workload-header-day-color);
      transition: color 0.3s ease;
      margin-top: var(--head-body-gap);
      margin-bottom: var(--head-body-gap);
    }

    .workload-shell .grid .head-site {
      position: sticky;
      left: 0;
      z-index: 4;
      background: var(--workload-headsite-bg);
      border-right: 1px solid var(--workload-sep);
      transition: background 0.3s ease, border-color 0.3s ease;
    }

    .workload-shell .grid .cell,
    .workload-shell .grid .site-cell,
    .workload-shell .grid .head-cell,
    .workload-shell .grid .site-head,
    .workload-shell .grid .week-cell,
    .workload-shell .grid .site-week {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .workload-shell .grid .site-row {
      background: var(--workload-site-row-bg);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      height: var(--cell-h);
      gap: 12px;
      transition: background 0.3s ease;
    }

    .workload-shell .grid .site-row:nth-of-type(even) {
      background: var(--workload-site-row-alt-bg);
    }

    .workload-shell .grid .site-row .meta {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: center;
      flex: 1;
      min-width: 0;
      overflow: hidden;
      gap: 4px;
    }

    .workload-shell .grid .site-row .site-name {
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .workload-shell .grid .site-row .info {
      font-size: 11px;
      color: var(--workload-muted);
      display: flex;
      align-items: center;
      gap: 6px;
      transition: color 0.3s ease;
    }

    .workload-shell .grid .site-row .count-ok {
      color: var(--workload-ok);
    }

    .workload-shell .grid .site-row .count-warn {
      color: var(--workload-warn);
    }

    .workload-shell .grid .site-row .count-bad {
      color: var(--workload-bad);
    }

    .workload-shell .grid .site-row .count-hours {
      color: var(--workload-fg);
      font-weight: 600;
    }

    .workload-shell .grid .site-row > .actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .workload-shell .grid .cell {
      height: var(--cell-h);
      width: var(--cell-w);
      border: 1px solid var(--workload-cell-border);
      border-radius: 6px;
      background: var(--workload-cell-bg);
      color: inherit;
      cursor: pointer;
      position: relative;
      font-weight: 600;
      font-size: 15px;
      transition: border-color 0.2s ease, transform 0.2s ease, background 0.2s ease, color 0.2s ease;
    }

    .workload-shell .grid .cell:hover,
    .workload-shell .grid .cell:focus-visible {
      border-color: var(--workload-cell-hover-border);
      outline: none;
      transform: translateY(-1px);
    }

    .workload-shell .grid .cell[data-state^="ok"] {
      background: var(--workload-ok-bg);
      border-color: var(--workload-ok-border);
      color: var(--workload-ok);
    }

    .workload-shell .grid .cell[data-state="bad"] {
      background: var(--workload-bad-bg);
      border-color: var(--workload-bad-border);
      color: var(--workload-bad);
    }

    .workload-shell .grid .cell[data-state="warn"] {
      background: var(--workload-warn-bg);
      border-color: var(--workload-warn-border);
      color: var(--workload-warn);
    }

    .workload-shell .grid .cell[data-state="ok"]::after {
      content: "";
      position: absolute;
      inset: 5px;
      border-radius: 4px;
      border: 2px dashed var(--workload-ok-dashed);
      opacity: 0.9;
    }

    .workload-shell .grid .cell[data-state^="ok:"]::after {
      content: none;
    }

    .workload-shell .grid .cell[data-state="bad"]::after,
    .workload-shell .grid .cell[data-state="warn"]::after {
      content: none;
    }

    .workload-shell .grid .cell:not([data-state])::after {
      content: "";
    }

    .workload-shell .grid .wk-sep {
      border-left: 2px solid var(--workload-week-divider);
      margin-left: -1px;
      transition: border-color 0.3s ease;
    }

    .workload-shell .btn {
      background: var(--workload-btn-bg);
      color: var(--workload-btn-text);
      border: 1px solid var(--workload-btn-border);
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 16px;
      line-height: 1.2;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease, transform 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }

    .workload-shell .btn:hover {
      background: var(--workload-btn-hover-bg);
      transform: translateY(-1px);
    }

    .workload-shell .muted {
      color: var(--workload-muted);
      transition: color 0.3s ease;
    }

    .workload-shell .mark {
      background: var(--workload-mark-bg);
      border-radius: 3px;
      padding: 0 2px;
      transition: background 0.3s ease;
    }

    .workload-toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: var(--workload-toast-bg);
      border: 1px solid var(--workload-toast-border);
      padding: 12px 14px;
      border-radius: 12px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.45);
      color: var(--workload-toast-color);
      font-size: 13px;
      z-index: 50;
      transition: background 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }

    .workload-sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    @media (max-width: 1024px) {
      .workload-shell {
        --left-col-w: 280px;
      }
    }

    @media (max-width: 768px) {
      .workload-shell {
        --left-col-w: 220px;
      }

      .workload-shell .toolbar {
        position: static;
      }
    }
  </style>
{% endblock %}
{% block main_classes %}space-y-12{% endblock %}
{% block content %}
  <section class="rounded-3xl border border-slate-200 bg-white/70 p-8 shadow-xl shadow-indigo-500/10 backdrop-blur dark:border-white/10 dark:bg-white/10 dark:shadow-indigo-500/20">
    <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
      <div class="space-y-4">
        <span class="inline-flex items-center gap-2 rounded-full border border-indigo-200 bg-indigo-50 px-4 py-1 text-xs font-semibold uppercase tracking-[0.35em] text-indigo-600 dark:border-indigo-400/40 dark:bg-indigo-500/10 dark:text-indigo-200">Vue synth√©tique</span>
        <h2 class="font-display text-2xl font-semibold text-slate-900 transition-colors duration-300 dark:text-white">Anticipez les pics d'activit√©</h2>
        <p class="max-w-2xl text-base text-slate-600 transition-colors duration-300 dark:text-slate-300">La vue plan de charge permet de projeter l'allocation des √©quipes sur 52 semaines. Planifiez vos sites, partagez vos donn√©es et identifiez imm√©diatement les semaines critiques.</p>
      </div>
      <dl class="grid gap-4 sm:grid-cols-2">
        <div class="rounded-3xl border border-emerald-200 bg-emerald-50/70 p-5 text-emerald-700 shadow shadow-emerald-200/50 transition-colors duration-300 dark:border-emerald-400/40 dark:bg-emerald-500/10 dark:text-emerald-100">
          <dt class="text-xs font-semibold uppercase tracking-[0.3em]">Sites suivis</dt>
          <dd class="mt-3 text-3xl font-semibold">{{ default_sites|length }}</dd>
          <p class="mt-2 text-sm">Importez vos donn√©es pour enrichir la projection hebdomadaire.</p>
        </div>
        <div class="rounded-3xl border border-sky-200 bg-sky-50/70 p-5 text-sky-700 shadow shadow-sky-200/50 transition-colors duration-300 dark:border-sky-400/40 dark:bg-sky-500/10 dark:text-sky-100">
          <dt class="text-xs font-semibold uppercase tracking-[0.3em]">P√©riode couverte</dt>
          <dd class="mt-3 text-3xl font-semibold">52 semaines</dd>
          <p class="mt-2 text-sm">Vue annuelle d√©taill√©e jour par jour avec rep√®res hebdomadaires.</p>
        </div>
      </dl>
    </div>
  </section>

  <section class="workload-shell mt-6">
    <div class="workload-app" id="workloadApp" aria-live="polite">
      <div class="toolbar" id="workloadToolbar">
        <div class="actions">
          <button class="btn" id="addSite">+ Site</button>
          <button class="btn" id="exportExcelBtn">Exporter Excel</button>
          <label for="importExcelFile" class="btn" role="button">Importer Excel<input id="importExcelFile" type="file" accept=".xlsx,.xlsm,.xltx,.xltm" style="display:none"></label>
        </div>
        <div class="actions">
          <label for="paintMode">Peinture</label>
          <select id="paintMode" aria-label="Mode de peinture">
            <option value="ok">Vert (planifi√©)</option>
            <option value="warn">Orange (√† revoir)</option>
            <option value="bad">Rouge (√† planifier)</option>
            <option value="erase">Effacer</option>
          </select>
          <span id="modeBadge" class="badge" aria-live="polite">
            <i class="dot" id="modeDot"></i>
            <span id="modeText">Mode&nbsp;: Vert</span>
            <span class="muted">(R: rouge, V: vert, O: orange, E: effacer)</span>
          </span>
        </div>
        <div class="grow"></div>
        <div class="actions">
          <label for="filterInput">Filtrer</label>
          <input id="filterInput" type="text" placeholder="Rechercher un site‚Ä¶" autocomplete="off">
          <span id="filterCount" class="muted">0/0</span>
        </div>
        <div class="actions">
          <label for="zoomRange">Zoom</label>
          <input id="zoomRange" type="range" min="18" max="48" value="28">
        </div>
      </div>

      <div class="wrap" id="workloadWrap">
        <div class="grid" id="grid" role="grid" aria-label="Plan de charge">
          <div class="site-week head-site header header-wk" role="columnheader" style="grid-row:1;grid-column:1">Semaines</div>
          <div class="site-head head-site header header-day" role="columnheader" style="grid-row:2;grid-column:1">Site / actions</div>

          <template id="dayHeadTpl">
            <div class="head-cell header header-day" role="columnheader"></div>
          </template>
          <template id="weekCellTpl">
            <div class="week-cell header header-wk" role="columnheader"></div>
          </template>
          <template id="siteRowTpl">
            <div class="site-cell head-site site-row" role="rowheader">
              <div class="meta">
                <strong class="site-name"></strong>
                <span class="info"></span>
              </div>
              <div class="actions">
                <button class="btn rename" title="Renommer">‚úèÔ∏è</button>
                <button class="btn del" title="Supprimer">üóëÔ∏è</button>
              </div>
            </div>
          </template>
          <template id="cellTpl">
            <button class="cell" role="gridcell" aria-pressed="false"></button>
          </template>
        </div>
      </div>
    </div>
  </section>
  <div id="toast" class="workload-toast" style="display:none"></div>

  <p class="sr-only workload-sr-only" id="workloadInstructions">
    Utilisez les touches R, V, O, E pour changer de mode de coloration. Appuyez sur Entr√©e pour peindre une cellule, fl√®ches pour naviguer.
  </p>

  <script>
    (function(){
      const VERSION = 4;
      const NS = 'pc:v4:';

      const grid = document.getElementById('grid');
      const filterInput = document.getElementById('filterInput');
      const filterCount = document.getElementById('filterCount');
      const zoomRange = document.getElementById('zoomRange');
      const paintModeSel = document.getElementById('paintMode');
      const modeDot = document.getElementById('modeDot');
      const modeText = document.getElementById('modeText');
      const addSiteBtn = document.getElementById('addSite');
      const exportExcelBtn = document.getElementById('exportExcelBtn');
      const importExcelFile = document.getElementById('importExcelFile');
      const toast = document.getElementById('toast');

      const dayHeadTpl = document.getElementById('dayHeadTpl');
      const weekCellTpl = document.getElementById('weekCellTpl');
      const siteRowTpl = document.getElementById('siteRowTpl');
      const cellTpl = document.getElementById('cellTpl');

      const DEFAULT_SITES = {{ default_sites|tojson }};
      const API_HEADERS = {
        'Content-Type': 'application/json',
        Accept: 'application/json'
      };

      const ls = {
        get(k, def){
          try {
            const v = localStorage.getItem(k);
            return v == null ? def : JSON.parse(v);
          } catch {
            return def;
          }
        },
        set(k, v){ localStorage.setItem(k, JSON.stringify(v)); },
        del(k){ localStorage.removeItem(k); }
      };

      const state = {
        sites: [],
        paint: ls.get(NS + 'paint', 'ok'),
        dragging: false,
        dragSet: new Map()
      };

      function normalizeSite(site){
        const cells = Array(364).fill('');
        (site.cells || []).forEach((value, idx)=>{
          if(idx < 364){
            const normalized = (value == null ? '' : String(value)).trim();
            cells[idx] = normalized;
          }
        });
        return {
          id: site.id,
          name: site.name,
          position: site.position ?? 0,
          cells
        };
      }

      function findSiteById(id){
        return state.sites.find(site => site.id === id);
      }

      function sortSites(){
        state.sites.sort((a, b)=>{
          if(a.position !== b.position) return a.position - b.position;
          return a.id - b.id;
        });
      }

      function setZoom(px){
        document.documentElement.style.setProperty('--cell-w', px + 'px');
        document.documentElement.style.setProperty('--cell-h', '40px');
      }

      function setPaintMode(mode){
        state.paint = mode; ls.set(NS + 'paint', mode);
        paintModeSel.value = mode;
        const map = {
          ok: ['#16a34a', 'Vert (planifi√©)'],
          warn: ['#fb923c', 'Orange (√† revoir)'],
          bad: ['#dc2626', 'Rouge (√† planifier)'],
          erase: ['#9ca3af', 'Effacer']
        };
        modeDot.style.background = map[mode][0];
        modeText.textContent = 'Mode\u00A0: ' + map[mode][1];
      }

      function showToast(msg){
        toast.textContent = msg;
        toast.style.display = 'block';
        clearTimeout(showToast._t);
        showToast._t = setTimeout(()=> toast.style.display = 'none', 2200);
      }

      function buildDayHeaders(){
        if(!grid.querySelector('.week-cell')){
          for(let w = 0; w < 52; w++){
            const n = weekCellTpl.content.firstElementChild.cloneNode(true);
            n.textContent = 'S' + String(w + 1).padStart(2, '0');
            n.style.gridRow = '1';
            n.style.gridColumn = (2 + w * 7) + ' / span 7';
            if(w > 0) n.classList.add('wk-sep');
            grid.appendChild(n);
          }
        }

        if(!grid.querySelector('.head-cell.header-day')){
          const DAYS = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
          for(let i = 0; i < 364; i++){
            const n = dayHeadTpl.content.firstElementChild.cloneNode(true);
            const dayIndex = i % 7;
            n.textContent = DAYS[dayIndex];
            n.style.gridRow = '2';
            n.style.gridColumn = String(2 + i);
            if(i > 0 && i % 7 === 0) n.classList.add('wk-sep');
            grid.appendChild(n);
          }
        }
      }

      function setCellPending(siteId, idx, value, previous){
        const key = `${siteId}:${idx}`;
        if(!state.dragSet.has(key)){
          state.dragSet.set(key, { siteId, idx, previous, value });
        } else {
          const entry = state.dragSet.get(key);
          if(!('previous' in entry)) entry.previous = previous;
          entry.value = value;
        }
      }

      async function loadData(){
        try{
          const resp = await fetch('/api/workload-plan');
          if(!resp.ok) throw new Error('Erreur de chargement');
          let data = await resp.json();
          let sites = data.sites || [];

          if(sites.length === 0 && DEFAULT_SITES.length){
            try{
              await fetch('/api/workload-plan/import', {
                method: 'POST',
                headers: API_HEADERS,
                body: JSON.stringify({ version: VERSION, sites: DEFAULT_SITES, cells: {} })
              });
              const retry = await fetch('/api/workload-plan');
              if(retry.ok){
                const retryData = await retry.json();
                sites = retryData.sites || [];
              }
            }catch(err){
              console.error('Bootstrap plan de charge impossible', err);
            }
          }

          state.sites = sites.map(normalizeSite);
          sortSites();
          state.dragSet.clear();
          render();
        }catch(err){
          console.error('Chargement du plan de charge √©chou√©', err);
          showToast('Impossible de charger le plan de charge');
        }
      }

      function render(){
        buildDayHeaders();
        grid.querySelectorAll('.site-row, .cell').forEach(n=> n.remove());
        const frag = document.createDocumentFragment();

        state.sites.forEach((site, rIndex)=>{
          const head = siteRowTpl.content.firstElementChild.cloneNode(true);
          const rowNumber = 3 + rIndex;
          head.style.gridColumn = '1';
          head.style.gridRow = String(rowNumber);
          head.dataset.siteId = String(site.id);
          head.dataset.siteName = site.name;
          const nameEl = head.querySelector('.site-name');
          nameEl.textContent = site.name;
          nameEl.dataset.originalName = site.name;
          frag.appendChild(head);

          for(let i = 0; i < 364; i++){
            const c = cellTpl.content.firstElementChild.cloneNode(true);
            const val = site.cells[i] || '';
            if(val){
              c.dataset.state = val;
              let displayContent = '';
              if(val === 'bad') displayContent = '8';
              else if(val === 'warn') displayContent = '4';
              else if(val.startsWith('ok:')) displayContent = val.split(':')[1];
              c.textContent = displayContent;
            }
            c.tabIndex = 0;
            c.dataset.idx = String(i);
            c.dataset.siteId = String(site.id);
            c.dataset.siteName = site.name;
            c.style.gridRow = String(rowNumber);
            c.style.gridColumn = String(2 + i);
            c.setAttribute('aria-label', `Site ${site.name}, jour ${i+1}: ${val || 'aucun √©tat'}`);
            c.setAttribute('aria-pressed', val ? 'true' : 'false');
            if(i > 0 && i % 7 === 0) c.classList.add('wk-sep');
            frag.appendChild(c);
          }
        });

        grid.appendChild(frag);
        updateProgressAll();
        applyFilter();
      }

      function updateProgressAll(){
        const rows = grid.querySelectorAll('.site-row');
        rows.forEach(row=>{
          const siteId = Number(row.dataset.siteId);
          const site = findSiteById(siteId);
          if(!site) return;
          let ok = 0, warn = 0, bad = 0, hours = 0;
          site.cells.forEach(value=>{
            if(!value) return;
            if(value.startsWith('ok')){
              ok++;
              const parts = value.split(':');
              if(parts.length > 1){
                const parsed = Number(parts[1]);
                if(!Number.isNaN(parsed)) hours += parsed;
              }
            }
            else if(value === 'warn'){
              warn++;
              hours += 4;
            }
            else if(value === 'bad'){
              bad++;
              hours += 8;
            }
          });
          const info = row.querySelector('.info');
          info.innerHTML = `<span class="count-ok">${ok}</span> vert ‚Ä¢ <span class="count-warn">${warn}</span> orange ‚Ä¢ <span class="count-bad">${bad}</span> rouge ‚Ä¢ <span class="count-hours">${hours}</span> h`;
        });
      }

      function highlight(text, q){
        if(!q) return text;
        const re = new RegExp('(' + q.replace(/[.*+?^${}()|[\\]\\]/g,'\\$&') + ')','i');
        return text.replace(re,'<span class="mark">$1</span>');
      }

      function applyFilter(){
        const q = filterInput.value.trim();
        const rows = Array.from(grid.querySelectorAll('.site-row'));
        let shown = 0;
        rows.forEach(row=>{
          const siteId = row.dataset.siteId;
          const nameEl = row.querySelector('.site-name');
          const original = nameEl.dataset.originalName || nameEl.textContent;
          const match = !q || original.toLowerCase().includes(q.toLowerCase());
          const cells = grid.querySelectorAll(`.cell[data-site-id="${siteId}"]`);

          if(match){
            shown++;
            const targetRow = 2 + shown;
            row.style.display = '';
            row.style.gridRow = String(targetRow);
            cells.forEach(cell=>{
              cell.style.display = '';
              cell.style.gridRow = String(targetRow);
            });
            nameEl.innerHTML = highlight(original, q);
          } else {
            row.style.display = 'none';
            row.style.removeProperty('grid-row');
            cells.forEach(cell=>{
              cell.style.display = 'none';
              cell.style.removeProperty('grid-row');
            });
            nameEl.textContent = original;
          }
        });
        filterCount.textContent = `${shown}/${rows.length}`;
      }

      function paintCell(el){
        const siteId = Number(el.dataset.siteId);
        const idx = Number(el.dataset.idx);
        const site = findSiteById(siteId);
        if(!site) return;
        const mode = state.paint;
        const currentState = site.cells[idx] || '';

        let valToStore = '';
        let valToDisplay = '';

        if (mode === 'ok') {
          if (currentState === 'bad') {
            valToStore = 'ok:8';
            valToDisplay = '8';
          } else if (currentState === 'warn') {
            valToStore = 'ok:4';
            valToDisplay = '4';
          } else if (currentState.startsWith('ok')) {
            valToStore = currentState;
            valToDisplay = el.textContent;
          } else {
            valToStore = '';
            valToDisplay = '';
          }

        } else if (mode === 'warn') {
          valToStore = 'warn';
          valToDisplay = '4';

        } else if (mode === 'bad') {
          valToStore = 'bad';
          valToDisplay = '8';

        } else if (mode === 'erase') {
          valToStore = '';
          valToDisplay = '';
        }

        if (valToStore === currentState) return;

        setCellPending(siteId, idx, valToStore, currentState);
        site.cells[idx] = valToStore;

        if(valToStore){
          el.dataset.state = valToStore;
          el.textContent = valToDisplay;
          el.setAttribute('aria-pressed','true');
          el.setAttribute('aria-label', `Site ${site.name}, jour ${idx+1}: ${valToStore} (${valToDisplay || '?'} jours)`);
        } else {
          el.removeAttribute('data-state');
          el.textContent = '';
          el.setAttribute('aria-pressed','false');
          el.setAttribute('aria-label', `Site ${site.name}, jour ${idx+1}: aucun √©tat`);
        }
      }

      async function flushCells(){
        if(state.dragSet.size === 0) return;
        const entries = Array.from(state.dragSet.values());
        const payload = {
          updates: entries.map(({ siteId, idx, value })=>({
            site_id: siteId,
            day_index: idx,
            value: value ? value : null
          }))
        };
        try{
          const resp = await fetch('/api/workload-plan/cells', {
            method: 'POST',
            headers: API_HEADERS,
            body: JSON.stringify(payload)
          });
          if(!resp.ok){
            let detail = 'Enregistrement impossible';
            try{
              const data = await resp.json();
              if(data && data.detail) detail = data.detail;
            }catch{}
            throw new Error(detail);
          }
        }catch(err){
          entries.forEach(entry=>{
            const site = findSiteById(entry.siteId);
            if(site){
              site.cells[entry.idx] = entry.previous || '';
            }
          });
          render();
          console.error('Mise √† jour √©chou√©e', err);
          showToast(err.message || 'Erreur lors de l\'enregistrement');
        }finally{
          state.dragSet.clear();
        }
      }

      grid.addEventListener('mousedown', e=>{
        if(e.target.classList.contains('cell')){
          state.dragging = true; paintCell(e.target);
          e.preventDefault();
        }
      });
      grid.addEventListener('mouseover', e=>{
        if(state.dragging && e.target.classList.contains('cell')) paintCell(e.target);
      });
      window.addEventListener('mouseup', ()=>{
        if(state.dragging){
          state.dragging = false;
          flushCells();
          updateProgressAll();
        }
      });

      document.addEventListener('keydown', e=>{
        if(['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)) return;
        if(e.key==='v' || e.key==='V'){ setPaintMode('ok'); showToast('Mode Vert'); }
        else if(e.key==='o' || e.key==='O'){ setPaintMode('warn'); showToast('Mode Orange'); }
        else if(e.key==='r' || e.key==='R'){ setPaintMode('bad'); showToast('Mode Rouge'); }
        else if(e.key==='e' || e.key==='E'){ setPaintMode('erase'); showToast('Mode Effacer'); }
      });

      grid.addEventListener('keydown', e=>{
        const el = e.target;
        if(!el.classList.contains('cell')) return;
        const idx = +el.dataset.idx;

        const moveFocus = (delta)=>{
          const i = Array.prototype.indexOf.call(grid.children, el);
          const next = grid.children[i + delta];
          if(next && next.classList.contains('cell')) next.focus();
        };

        if(e.key==='Enter' || e.key===' '){ paintCell(el); e.preventDefault(); flushCells(); updateProgressAll(); return; }
        else if(e.key==='ArrowRight'){ moveFocus(1); e.preventDefault(); }
        else if(e.key==='ArrowLeft'){ moveFocus(-1); e.preventDefault(); }
        else if(e.key==='ArrowDown'){ moveFocus(365); e.preventDefault(); }
        else if(e.key==='ArrowUp'){ moveFocus(-365); e.preventDefault(); }
        else if(e.key==='Home'){
          const delta = -(idx % 7); moveFocus(delta); e.preventDefault();
        }
        else if(e.key==='End'){
          const delta = 6 - (idx % 7); moveFocus(delta); e.preventDefault();
        }
        else if(e.key==='PageDown'){ moveFocus(7); e.preventDefault(); }
        else if(e.key==='PageUp'){ moveFocus(-7); e.preventDefault(); }
      });

      zoomRange.addEventListener('input', e=> setZoom(+e.target.value));
      paintModeSel.addEventListener('change', e=> setPaintMode(e.target.value));
      filterInput.addEventListener('input', applyFilter);

      addSiteBtn.addEventListener('click', async ()=>{
        const name = prompt('Nom du site ?');
        if(!name) return;
        const normalized = name.trim();
        if(!normalized) return showToast('Nom requis');
        if(state.sites.some(site => site.name.toLowerCase() === normalized.toLowerCase())){
          return showToast('Ce nom existe d√©j√†');
        }
        try{
          const resp = await fetch('/api/workload-plan/sites', {
            method: 'POST',
            headers: API_HEADERS,
            body: JSON.stringify({ name: normalized })
          });
          if(!resp.ok){
            let detail = 'Impossible de cr√©er le site';
            try{
              const data = await resp.json();
              if(data && data.detail) detail = data.detail;
            }catch{}
            throw new Error(detail);
          }
          const site = await resp.json();
          state.sites.push(normalizeSite(site));
          sortSites();
          render();
          showToast('Site ajout√©');
        }catch(err){
          console.error('Ajout site √©chou√©', err);
          showToast(err.message || 'Erreur lors de l\'ajout');
        }
      });

      grid.addEventListener('click', async e=>{
        const row = e.target.closest('.site-row');
        if(!row) return;
        const siteId = Number(row.dataset.siteId);
        const site = findSiteById(siteId);
        if(!site) return;

        if(e.target.classList.contains('rename')){
          const nv = prompt('Nouveau nom ?', site.name);
          if(!nv) return;
          const normalized = nv.trim();
          if(!normalized || normalized === site.name) return;
          if(state.sites.some(s => s.id !== siteId && s.name.toLowerCase() === normalized.toLowerCase())){
            return showToast('Nom d√©j√† utilis√©');
          }
          try{
            const resp = await fetch(`/api/workload-plan/sites/${siteId}`, {
              method: 'PATCH',
              headers: API_HEADERS,
              body: JSON.stringify({ name: normalized })
            });
            if(!resp.ok){
              let detail = 'Impossible de renommer le site';
              try{
                const data = await resp.json();
                if(data && data.detail) detail = data.detail;
              }catch{}
              throw new Error(detail);
            }
            const updated = normalizeSite(await resp.json());
            const idx = state.sites.findIndex(s => s.id === siteId);
            if(idx !== -1){
              state.sites[idx] = { ...updated, position: state.sites[idx].position };
            }
            render();
            showToast('Site renomm√©');
          }catch(err){
            console.error('Renommage √©chou√©', err);
            showToast(err.message || 'Erreur lors du renommage');
          }
        }

        if(e.target.classList.contains('del')){
          if(!confirm(`Supprimer le site ¬´ ${site.name} ¬ª ?`)) return;
          try{
            const resp = await fetch(`/api/workload-plan/sites/${siteId}`, {
              method: 'DELETE'
            });
            if(resp.status !== 204){
              let detail = 'Impossible de supprimer le site';
              try{
                const data = await resp.json();
                if(data && data.detail) detail = data.detail;
              }catch{}
              throw new Error(detail);
            }
            state.sites = state.sites.filter(s => s.id !== siteId);
            render();
            showToast('Site supprim√©');
          }catch(err){
            console.error('Suppression √©chou√©e', err);
            showToast(err.message || 'Erreur lors de la suppression');
          }
        }
      });

      if(exportExcelBtn){
        exportExcelBtn.addEventListener('click', async ()=>{
          try{
            const resp = await fetch('/api/workload-plan/export/excel');
            if(!resp.ok){
              let detail = 'Export Excel impossible';
              try{
                const errData = await resp.json();
                if(errData && errData.detail) detail = errData.detail;
              }catch{}
              throw new Error(detail);
            }
            const blob = await resp.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'plan_de_charge.xlsx';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Export Excel effectu√©');
          }catch(err){
            console.error('Export Excel √©chou√©', err);
            showToast(err.message || "Erreur lors de l'export Excel");
          }
        });
      }

      if(importExcelFile){
        importExcelFile.addEventListener('change', async (e)=>{
          const f = e.target.files[0];
          if(!f) return;
          const formData = new FormData();
          formData.append('file', f);
          try{
            const resp = await fetch('/api/workload-plan/import/excel', {
              method: 'POST',
              body: formData
            });
            if(!resp.ok){
              let detail = 'Import Excel impossible';
              try{
                const errData = await resp.json();
                if(errData && errData.detail) detail = errData.detail;
              }catch{}
              throw new Error(detail);
            }
            await loadData();
            showToast('Import Excel termin√©');
          }catch(err){
            console.error('Import Excel √©chou√©', err);
            showToast(err.message || "Erreur lors de l'import Excel");
          }finally{
            importExcelFile.value = '';
          }
        });
      }

      async function init(){
        setZoom(+zoomRange.value);
        setPaintMode(state.paint);
        await loadData();
        runTests();
      }

      function runTests(){
        try{
          console.group('%cTests plan de charge','color:#93c5fd');
          const weeks = grid.querySelectorAll('.week-cell');
          const days = grid.querySelectorAll('.head-cell.header-day');
          console.assert(weeks.length===52, `Semaine headers attendus 52, obtenus ${weeks.length}`);
          console.assert(days.length===364, `Jour headers attendus 364, obtenus ${days.length}`);
          const row = grid.querySelector('.site-row');
          if(row){
            const rowNum = row.style.gridRow;
            let cnt=0, sameRow=true;
            for(let i=0;i<364;i++){
              const n=grid.querySelector(`.cell[style*="grid-row: ${rowNum};"][style*="grid-column: ${2+i}"]`);
              if(n){cnt++;}
              else {sameRow=false; break;}
            }
            console.assert(cnt===364 && sameRow, `Cellules par ligne attendues 364 sur grid-row ${rowNum}, trouv√©es ${cnt}`);
          }
          const before = filterCount.textContent;
          if(state.sites.some(site => site.name === 'Site A')){
            filterInput.value = 'Site A'; applyFilter();
            const after = filterCount.textContent;
            console.assert(before!==after && /\d+\/\d+/.test(after), `Compteur de filtre devrait changer (avant=${before}, apr√®s=${after})`);
          }
          filterInput.value = ''; applyFilter();
          console.groupEnd();
        }catch(e){ console.error('Tests en erreur:', e); }
      }

      init();
    })();
  </script>
{% endblock %}
