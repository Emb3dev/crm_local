{% extends "base.html" %}
{% block main_classes %}container container-wide{% endblock %}
{% block page_eyebrow %}Gestion clients{% endblock %}
{% block page_title %}Portefeuille clients{% endblock %}
{% block page_subtitle %}Acc√©dez rapidement √† vos comptes, filtrez vos donn√©es et pilotez l'activit√© commerciale en quelques clics.{% endblock %}
{% block title %}Clients ‚Äî CRM Local{% endblock %}
{% block content %}
{% if import_report %}
<div class="alert {{ 'success' if not import_report.errors else 'warning' }}">
  <div class="alert-title">Import termin√©</div>
  <p>
    {{ import_report.created }} client{{ 's' if import_report.created > 1 else '' }} import√©{{ 's' if import_report.created > 1 else '' }}
    sur {{ import_report.total }} depuis <strong>{{ import_report.filename }}</strong>.
  </p>
  {% if import_report.errors %}
  <p class="alert-subtitle">Certaines lignes n'ont pas pu √™tre import√©es :</p>
  <ul class="alert-list">
    {% for err in import_report.errors %}
    <li>{{ err }}</li>
    {% endfor %}
  </ul>
  {% endif %}
</div>
{% endif %}

<section class="panel">
  <div class="panel-header">
    <div class="panel-title">
      <h2>Clients</h2>
      <p class="panel-subtitle">Consultez et filtrez votre portefeuille client.</p>
    </div>
    <form class="search" role="search" hx-get="/_clients" hx-target="#list" hx-trigger="keyup changed delay:300ms">
      <input type="text" name="q" placeholder="Rechercher (entreprise, client, contact‚Ä¶)" value="{{ q }}" aria-label="Rechercher un client" />
      <button class="btn ghost" type="submit">Filtrer</button>
    </form>
  </div>

  <div class="panel-body">
    <div class="table-wrap" id="list">
      <table class="table">
        <thead>
          <tr>
            <th>Entreprise</th>
            <th>Client</th>
            <th>Email</th>
            <th>T√©l√©phone</th>
            <th>Adresse de facturation</th>
            <th>D√©pannage</th>
            <th>Astreinte</th>
            <th>Tags</th>
            <th>Statut</th>
            <th class="th-actions">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for c in clients %}
          <tr>
            <td data-label="Entreprise">{{ c.company_name }}</td>
            <td data-label="Client">{{ c.name }}</td>
            <td data-label="Email">{{ c.email or "‚Äî" }}</td>
            <td data-label="T√©l√©phone">{{ c.phone or "‚Äî" }}</td>
            <td data-label="Adresse de facturation">{{ c.billing_address or "‚Äî" }}</td>
            <td data-label="D√©pannage">{{ depannage_options.get(c.depannage, "‚Äî") }}</td>
            <td data-label="Astreinte">{{ astreinte_options.get(c.astreinte, "‚Äî") }}</td>
            <td data-label="Tags">{{ c.tags or "‚Äî" }}</td>
            <td data-label="Statut">
              {% set status_key = c.status or "" %}
              <span class="badge {{ 'success' if status_key == 'actif' else 'neutral' if not status_key else 'danger' }}">
                {{ status_options.get(status_key, status_key or "‚Äî") }}
              </span>
            </td>
            <td class="actions">
              <form action="/clients/{{ c.id }}/delete" method="post" onsubmit="return confirm('Supprimer {{ c.name }} ?')">
                <button class="btn danger sm" title="Supprimer">üóëÔ∏è</button>
              </form>
            </td>
          </tr>
          {% endfor %}
          {% if not clients %}
          <tr><td colspan="10" class="empty">Aucun r√©sultat</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<div class="panels-grid">
  <section class="panel">
    <div class="panel-header">
      <div class="panel-title">
        <h2>Import Excel</h2>
        <p class="panel-subtitle">Mettez √† jour votre base en important plusieurs clients √† la fois.</p>
      </div>
    </div>
    <div class="panel-body">
      <form action="/clients/import" method="post" enctype="multipart/form-data" class="form-grid import-form">
        <label class="full">
          <span>Fichier Excel (.xlsx)</span>
          <input type="file" name="file" accept=".xlsx,.xlsm,.xltx,.xltm" required />
        </label>
        <div class="form-actions full">
          <button class="btn primary" type="submit">Importer</button>
          <a class="btn ghost" href="/clients/import/template">T√©l√©charger le mod√®le Excel</a>
          <p class="form-hint">Colonnes minimales : Nom entreprise et Nom client. Colonnes optionnelles prises en charge : Email, T√©l√©phone, Adresse de facturation, D√©pannage, Astreinte, Tags, Statut.</p>
        </div>
      </form>
    </div>
  </section>

  <section class="panel">
    <div class="panel-header">
      <div class="panel-title">
        <h2>Nouveau client</h2>
        <p class="panel-subtitle">Ajoutez un dossier client en quelques informations cl√©s.</p>
      </div>
    </div>
    <div class="panel-body">
      <form action="/clients/new" method="post" class="form-grid">
        <label>
          <span>Nom entreprise *</span>
          <input name="company_name" required placeholder="Ex: Dupont SARL" />
        </label>
        <label>
          <span>Nom client *</span>
          <input name="name" required placeholder="Ex: Jeanne Martin" />
        </label>
        <label>
          <span>Email</span>
          <input name="email" type="email" placeholder="contact@exemple.fr" />
        </label>
        <label>
          <span>T√©l√©phone</span>
          <input name="phone" placeholder="06 12 34 56 78" />
        </label>
        <label class="full">
          <span>Adresse de facturation</span>
          <textarea name="billing_address" rows="3" placeholder="Rue, code postal, ville‚Ä¶"></textarea>
        </label>
        <label>
          <span>D√©pannage</span>
          <select name="depannage">
            {% for value, label in depannage_options.items() %}
            <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          <span>Astreinte</span>
          <select name="astreinte">
            {% for value, label in astreinte_options.items() %}
            <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          <span>Tags</span>
          <input name="tags" placeholder="Ex: premium, 2024" />
        </label>
        <label>
          <span>Statut</span>
          <select name="status">
            {% for value, label in status_options.items() %}
            <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </label>
        <div class="form-actions full">
          <button class="btn primary" type="submit">Ajouter</button>
        </div>
      </form>
    </div>
  </section>
</div>
{% endblock %}
