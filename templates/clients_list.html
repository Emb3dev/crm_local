{% extends "base.html" %}
{% block main_classes %}app-shell__surface app-shell__surface--wide{% endblock %}
{% block page_eyebrow %}Gestion clients{% endblock %}
{% block page_title %}Portefeuille clients{% endblock %}
{% block page_subtitle %}Acc√©dez rapidement √† vos comptes, filtrez vos donn√©es et pilotez l'activit√© commerciale en quelques clics.{% endblock %}
{% block title %}Clients ‚Äî CRM Local{% endblock %}
{% block content %}
{% if import_report %}
<div class="alert {{ 'success' if not import_report.errors else 'warning' }}">
  <div class="alert-title">Import termin√©</div>
  <p>
    {{ import_report.created }} client{{ 's' if import_report.created > 1 else '' }} import√©{{ 's' if import_report.created > 1 else '' }}
    sur {{ import_report.total }} depuis <strong>{{ import_report.filename }}</strong>.
  </p>
  {% if import_report.errors %}
  <p class="alert-subtitle">Certaines lignes n'ont pas pu √™tre import√©es :</p>
  <ul class="alert-list">
    {% for err in import_report.errors %}
    <li>{{ err }}</li>
    {% endfor %}
  </ul>
  {% endif %}
</div>
{% endif %}

<section class="panel">
  <div class="panel-header">
    <div class="panel-title">
      <h2>Clients</h2>
      <p class="panel-subtitle">Consultez et filtrez votre portefeuille client.</p>
    </div>
    <form class="search" role="search" hx-get="/_clients" hx-target="#list" hx-trigger="keyup changed delay:300ms">
      <input type="text" name="q" placeholder="Rechercher (entreprise, client, contact‚Ä¶)" value="{{ q }}" aria-label="Rechercher un client" />
      <button class="btn ghost" type="submit">Filtrer</button>
    </form>
  </div>

  <div class="panel-body">
    <div id="list" class="client-list">
      {% if clients %}
        {% for c in clients %}
          {% set status_key = c.status or "" %}
          {% set primary_has_data = 1 if c.name or c.email or c.phone else 0 %}
          {% set contact_list = c.contacts or [] %}
          {% set contact_total = primary_has_data + (contact_list | length) %}
          {% set is_target = focus_id and focus_id|int == c.id %}
          <details class="client-card" id="client-{{ c.id }}" {% if is_target %}open{% endif %}>
            <summary>
              <div class="client-card__summary">
                <div class="client-card__identity">
                  <h3>{{ c.company_name }}</h3>
                  <p class="client-card__primary">Contact principal :
                    {% if c.name %}
                      <strong>{{ c.name }}</strong>
                    {% else %}
                      <span class="client-card__empty">√† renseigner</span>
                    {% endif %}
                  </p>
                  {% if c.tags %}
                    <span class="client-card__tags">{{ c.tags }}</span>
                  {% endif %}
                </div>
                <div class="client-card__meta">
                  <span class="badge {{ 'success' if status_key == 'actif' else 'neutral' if not status_key else 'danger' }}">
                    {{ status_options.get(status_key, status_key or "‚Äî") }}
                  </span>
                  <span class="client-card__count">{{ contact_total }} contact{{ 's' if contact_total > 1 else '' }}</span>
                  <span class="client-card__toggle" aria-hidden="true">‚ñº</span>
                </div>
              </div>
            </summary>
            <div class="client-card__body">
              <div class="client-card__grid">
                <section class="client-card__section">
                  <h4>Informations client</h4>
                  <dl class="client-card__dl">
                    <div>
                      <dt>Entreprise</dt>
                      <dd>{{ c.company_name }}</dd>
                    </div>
                    <div>
                      <dt>Adresse de facturation</dt>
                      <dd>{{ c.billing_address or "‚Äî" }}</dd>
                    </div>
                    <div>
                      <dt>Tags</dt>
                      <dd>{{ c.tags or "‚Äî" }}</dd>
                    </div>
                  </dl>
                </section>
                <section class="client-card__section">
                  <h4>Prestations</h4>
                  <dl class="client-card__dl">
                    <div>
                      <dt>D√©pannage</dt>
                      <dd>{{ depannage_options.get(c.depannage, "‚Äî") }}</dd>
                    </div>
                    <div>
                      <dt>Astreinte</dt>
                      <dd>{{ astreinte_options.get(c.astreinte, "‚Äî") }}</dd>
                    </div>
                    <div>
                      <dt>Statut</dt>
                      <dd>
                        <span class="badge {{ 'success' if status_key == 'actif' else 'neutral' if not status_key else 'danger' }}">
                          {{ status_options.get(status_key, status_key or "‚Äî") }}
                        </span>
                      </dd>
                    </div>
                  </dl>
                </section>
              </div>

              <section class="client-card__section client-card__section--contacts">
                <h4>Contacts</h4>
                <ul class="contact-list">
                  {% if c.name or c.email or c.phone %}
                    <li class="contact-list__item">
                      <div class="contact-list__header">
                        <span class="contact-list__name">{{ c.name or 'Contact principal' }}</span>
                        <span class="contact-list__badge">Principal</span>
                      </div>
                      <div class="contact-list__meta">
                        {% if c.email %}
                          <a href="mailto:{{ c.email }}">{{ c.email }}</a>
                        {% endif %}
                        {% if c.phone %}
                          <a href="tel:{{ c.phone }}">{{ c.phone }}</a>
                        {% endif %}
                        {% if not c.email and not c.phone %}
                          <span>Coordonn√©es √† renseigner</span>
                        {% endif %}
                      </div>
                    </li>
                  {% endif %}
                  {% for contact in contact_list | sort(attribute='name') %}
                    <li class="contact-list__item">
                      <div class="contact-list__header">
                        <span class="contact-list__name">{{ contact.name }}</span>
                        <form action="/clients/{{ c.id }}/contacts/{{ contact.id }}/delete" method="post" onsubmit="return confirm('Supprimer {{ contact.name }} ?')">
                          <button class="btn danger xs" type="submit" title="Supprimer le contact">üóëÔ∏è</button>
                        </form>
                      </div>
                      <div class="contact-list__meta">
                        {% if contact.email %}
                          <a href="mailto:{{ contact.email }}">{{ contact.email }}</a>
                        {% endif %}
                        {% if contact.phone %}
                          <a href="tel:{{ contact.phone }}">{{ contact.phone }}</a>
                        {% endif %}
                        {% if not contact.email and not contact.phone %}
                          <span>Coordonn√©es √† renseigner</span>
                        {% endif %}
                      </div>
                    </li>
                  {% endfor %}
                  {% if not (c.name or c.email or c.phone) and not contact_list %}
                    <li class="contact-list__empty">Aucun contact pour le moment.</li>
                  {% endif %}
                </ul>

                <form class="contact-form" action="/clients/{{ c.id }}/contacts" method="post">
                  <div class="contact-form__grid">
                    <label>
                      <span>Nom *</span>
                      <input name="contact_name" required placeholder="Pr√©nom Nom" />
                    </label>
                    <label>
                      <span>Email</span>
                      <input name="contact_email" type="email" placeholder="contact@exemple.fr" />
                    </label>
                    <label>
                      <span>T√©l√©phone</span>
                      <input name="contact_phone" placeholder="06 00 00 00 00" />
                    </label>
                  </div>
                  <div class="form-actions">
                    <button class="btn ghost sm" type="submit">Ajouter un contact</button>
                  </div>
                </form>
              </section>

              <section class="client-card__section client-card__section--subcontractings">
                <h4>Prestations sous-trait√©es & locations</h4>
                {% set services = c.subcontractings | sort(attribute='created_at', reverse=True) %}
                {% if services %}
                <ul class="subcontract-list">
                  {% for service in services %}
                    {% set frequency_label = frequency_options.get(service.frequency, service.frequency) %}
                    <li class="subcontract-list__item">
                      <div class="subcontract-list__header">
                        <div class="subcontract-list__identity">
                          <span class="subcontract-list__title">{{ service.prestation_label }}</span>
                          <span class="subcontract-list__category">{{ service.category }}</span>
                        </div>
                        <div class="subcontract-list__actions">
                          <span class="badge neutral subcontract-list__badge">{{ frequency_label }}</span>
                          <form action="/clients/{{ c.id }}/subcontractings/{{ service.id }}/delete" method="post" onsubmit="return confirm('Supprimer {{ service.prestation_label }} ?')">
                            <button class="btn danger xs" type="submit" title="Supprimer la prestation">üóëÔ∏è</button>
                          </form>
                        </div>
                      </div>
                      <dl class="subcontract-list__dl">
                        <div>
                          <dt>Code budget</dt>
                          <dd>{{ service.budget_code }}</dd>
                        </div>
                        <div>
                          <dt>Budget</dt>
                          <dd>
                            {% if service.budget is not none %}
                              {{ '{:,.2f}'.format(service.budget).replace(',', ' ').rstrip('0').rstrip('.') }} ‚Ç¨
                            {% else %}
                              ‚Äî
                            {% endif %}
                          </dd>
                        </div>
                        <div>
                          <dt>Semaine de r√©alisation</dt>
                          <dd>{{ service.realization_week or '‚Äî' }}</dd>
                        </div>
                        <div>
                          <dt>Semaine de commande</dt>
                          <dd>{{ service.order_week or '‚Äî' }}</dd>
                        </div>
                      </dl>
                    </li>
                  {% endfor %}
                </ul>
                {% else %}
                  <p class="subcontract-list__empty">Aucune prestation enregistr√©e pour le moment.</p>
                {% endif %}

                <form class="subcontract-form" action="/clients/{{ c.id }}/subcontractings" method="post">
                  <div class="subcontract-form__grid">
                    <label class="full">
                      <span>Prestation *</span>
                      <select name="prestation" required data-prestation-select>
                        <option value="" selected disabled>Choisir une prestation‚Ä¶</option>
                        {% for group in subcontracted_groups %}
                        <optgroup label="{{ group.title }}">
                          {% for option in group.options %}
                          <option value="{{ option.value }}" data-budget-code="{{ option.budget_code }}">{{ option.label }}</option>
                          {% endfor %}
                        </optgroup>
                        {% endfor %}
                      </select>
                    </label>
                    <label>
                      <span>Code budget</span>
                      <input type="text" readonly placeholder="Auto" data-budget-output />
                    </label>
                    <label>
                      <span>Budget</span>
                      <input type="number" name="budget" step="0.01" min="0" placeholder="0,00" />
                    </label>
                    <label>
                      <span>Fr√©quence</span>
                      <select name="frequency" required data-frequency-select>
                        {% for value, label in frequency_options.items() %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                      </select>
                    </label>
                    <label class="subcontract-form__week is-hidden" data-week-field>
                      <span>Semaine de r√©alisation</span>
                      <input type="text" name="realization_week" placeholder="S01" pattern="S\d{2}" disabled />
                    </label>
                    <label>
                      <span>Semaine de commande</span>
                      <input type="text" name="order_week" placeholder="S01" pattern="S\d{2}" />
                    </label>
                  </div>
                  <div class="form-actions">
                    <button class="btn ghost sm" type="submit">Ajouter une prestation</button>
                  </div>
                </form>
              </section>

              <div class="client-card__footer">
                <form action="/clients/{{ c.id }}/delete" method="post" onsubmit="return confirm('Supprimer {{ c.company_name }} ?')">
                  <button class="btn danger sm" type="submit">Supprimer le client</button>
                </form>
              </div>
            </div>
          </details>
        {% endfor %}
      {% else %}
        <p class="client-list__empty">Aucun r√©sultat</p>
      {% endif %}
    </div>
</div>
</section>

<div class="panels-grid">
  <section class="panel">
    <div class="panel-header">
      <div class="panel-title">
        <h2>Import Excel</h2>
        <p class="panel-subtitle">Mettez √† jour votre base en important plusieurs clients √† la fois.</p>
      </div>
    </div>
    <div class="panel-body">
      <form action="/clients/import" method="post" enctype="multipart/form-data" class="form-grid import-form">
        <label class="full">
          <span>Fichier Excel (.xlsx)</span>
          <input type="file" name="file" accept=".xlsx,.xlsm,.xltx,.xltm" required />
        </label>
        <div class="form-actions full">
          <button class="btn primary" type="submit">Importer</button>
          <a class="btn ghost" href="/clients/import/template">T√©l√©charger le mod√®le Excel</a>
          <p class="form-hint">Colonnes minimales : Nom entreprise et Nom client. Colonnes optionnelles prises en charge : Email, T√©l√©phone, Adresse de facturation, D√©pannage, Astreinte, Tags, Statut, ainsi que des colonnes <code>contact_2_*</code>, <code>contact_3_*</code>‚Ä¶ pour importer des contacts suppl√©mentaires.</p>
        </div>
      </form>
    </div>
  </section>

  <section class="panel">
    <div class="panel-header">
      <div class="panel-title">
        <h2>Nouveau client</h2>
        <p class="panel-subtitle">Ajoutez un dossier client en quelques informations cl√©s.</p>
      </div>
    </div>
    <div class="panel-body">
      <form action="/clients/new" method="post" class="form-grid">
        <label>
          <span>Nom entreprise *</span>
          <input name="company_name" required placeholder="Ex: Dupont SARL" />
        </label>
        <label>
          <span>Contact principal *</span>
          <input name="name" required placeholder="Ex: Jeanne Martin" />
        </label>
        <label>
          <span>Email du contact</span>
          <input name="email" type="email" placeholder="contact@exemple.fr" />
        </label>
        <label>
          <span>T√©l√©phone du contact</span>
          <input name="phone" placeholder="06 12 34 56 78" />
        </label>
        <label class="full">
          <span>Adresse de facturation</span>
          <textarea name="billing_address" rows="3" placeholder="Rue, code postal, ville‚Ä¶"></textarea>
        </label>
        <label>
          <span>D√©pannage</span>
          <select name="depannage">
            {% for value, label in depannage_options.items() %}
            <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          <span>Astreinte</span>
          <select name="astreinte">
            {% for value, label in astreinte_options.items() %}
            <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          <span>Tags</span>
          <input name="tags" placeholder="Ex: premium, 2024" />
        </label>
        <label>
          <span>Statut</span>
          <select name="status">
            {% for value, label in status_options.items() %}
            <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </label>
        <div class="form-actions full">
          <button class="btn primary" type="submit">Ajouter</button>
        </div>
      </form>
    </div>
  </section>
</div>
<script>
  (function() {
    const initForm = (form) => {
      if (!form || form.dataset.enhanced === 'true') return;
      const prestationSelect = form.querySelector('[data-prestation-select]');
      const budgetOutput = form.querySelector('[data-budget-output]');
      const frequencySelect = form.querySelector('[data-frequency-select]');
      const weekField = form.querySelector('[data-week-field]');
      const weekInput = weekField?.querySelector('input');

      const updateBudget = () => {
        if (!prestationSelect || !budgetOutput) return;
        const selected = prestationSelect.options[prestationSelect.selectedIndex];
        budgetOutput.value = selected?.dataset?.budgetCode || '';
      };

      const toggleWeekField = () => {
        if (!frequencySelect || !weekField || !weekInput) return;
        const isPonctual = frequencySelect.value === 'prestation_ponctuelle';
        weekField.classList.toggle('is-hidden', !isPonctual);
        weekInput.disabled = !isPonctual;
        if (!isPonctual) {
          weekInput.value = '';
        }
      };

      prestationSelect?.addEventListener('change', updateBudget);
      frequencySelect?.addEventListener('change', toggleWeekField);

      updateBudget();
      toggleWeekField();
      form.dataset.enhanced = 'true';
    };

    const enhanceAll = () => {
      document.querySelectorAll('.subcontract-form').forEach(initForm);
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', enhanceAll, { once: true });
    } else {
      enhanceAll();
    }

    document.body?.addEventListener('htmx:afterSwap', enhanceAll);
  })();
</script>
{% endblock %}
