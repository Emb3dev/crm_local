{% extends "base.html" %}
{% block main_classes %}container container-wide{% endblock %}
{% block title %}Clients â€” CRM Local{% endblock %}
{% block content %}
{% if import_report %}
<div class="alert {{ 'success' if not import_report.errors else 'warning' }}">
  <div class="alert-title">Import terminÃ©</div>
  <p>
    {{ import_report.created }} client{{ 's' if import_report.created > 1 else '' }} importÃ©{{ 's' if import_report.created > 1 else '' }}
    sur {{ import_report.total }} depuis <strong>{{ import_report.filename }}</strong>.
  </p>
  {% if import_report.errors %}
  <p class="alert-subtitle">Certaines lignes n'ont pas pu Ãªtre importÃ©es :</p>
  <ul class="alert-list">
    {% for err in import_report.errors %}
    <li>{{ err }}</li>
    {% endfor %}
  </ul>
  {% endif %}
</div>
{% endif %}

<section class="panel">
  <div class="panel-header">
    <h2>Clients</h2>
    <form class="search" hx-get="/_clients" hx-target="#list" hx-trigger="keyup changed delay:300ms">
      <input type="text" name="q" placeholder="Rechercher (entreprise, client, contactâ€¦)" value="{{ q }}" />
      <button class="btn ghost" type="submit">Rechercher</button>
    </form>
  </div>

  <div class="table-wrap" id="list">
    <table class="table">
      <thead>
        <tr>
          <th>Entreprise</th>
          <th>Client</th>
          <th>Email</th>
          <th>TÃ©lÃ©phone</th>
          <th>Adresse de facturation</th>
          <th>DÃ©pannage</th>
          <th>Astreinte</th>
          <th>Tags</th>
          <th>Statut</th>
          <th class="th-actions">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for c in clients %}
        <tr>
          <td data-label="Entreprise">{{ c.company_name }}</td>
          <td data-label="Client">{{ c.name }}</td>
          <td data-label="Email">{{ c.email or "â€”" }}</td>
          <td data-label="TÃ©lÃ©phone">{{ c.phone or "â€”" }}</td>
          <td data-label="Adresse de facturation">{{ c.billing_address or "â€”" }}</td>
          <td data-label="DÃ©pannage">{{ depannage_options.get(c.depannage, "â€”") }}</td>
          <td data-label="Astreinte">{{ astreinte_options.get(c.astreinte, "â€”") }}</td>
          <td data-label="Tags">{{ c.tags or "â€”" }}</td>
          <td data-label="Statut">
            {% set status_key = c.status or "" %}
            <span class="badge {{ 'success' if status_key == 'actif' else 'neutral' if not status_key else 'danger' }}">
              {{ status_options.get(status_key, status_key or "â€”") }}
            </span>
          </td>
          <td class="actions">
            <form action="/clients/{{ c.id }}/delete" method="post" onsubmit="return confirm('Supprimer {{ c.name }} ?')">
              <button class="btn danger sm" title="Supprimer">ğŸ—‘ï¸</button>
            </form>
          </td>
        </tr>
        {% endfor %}
        {% if not clients %}
        <tr><td colspan="10" class="empty">Aucun rÃ©sultat</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</section>

<section class="panel">
  <div class="panel-header">
    <h2>Import Excel</h2>
  </div>
  <form action="/clients/import" method="post" enctype="multipart/form-data" class="form-grid import-form">
    <label class="full">
      <span>Fichier Excel (.xlsx)</span>
      <input type="file" name="file" accept=".xlsx,.xlsm,.xltx,.xltm" required />
    </label>
    <div class="form-actions full">
      <button class="btn primary" type="submit">Importer</button>
      <p class="form-hint">Colonnes minimales : Nom entreprise et Nom client. Colonnes optionnelles prises en charge : Email, TÃ©lÃ©phone, Adresse de facturation, DÃ©pannage, Astreinte, Tags, Statut.</p>
    </div>
  </form>
</section>

<section class="panel">
  <div class="panel-header">
    <h2>Nouveau client</h2>
  </div>
  <form action="/clients/new" method="post" class="form-grid">
    <label>
      <span>Nom entreprise *</span>
      <input name="company_name" required placeholder="Ex: Dupont SARL" />
    </label>
    <label>
      <span>Nom client *</span>
      <input name="name" required placeholder="Ex: Jeanne Martin" />
    </label>
    <label>
      <span>Email</span>
      <input name="email" type="email" placeholder="contact@exemple.fr" />
    </label>
    <label>
      <span>TÃ©lÃ©phone</span>
      <input name="phone" placeholder="06 12 34 56 78" />
    </label>
    <label class="full">
      <span>Adresse de facturation</span>
      <textarea name="billing_address" rows="3" placeholder="Rue, code postal, villeâ€¦"></textarea>
    </label>
    <label>
      <span>DÃ©pannage</span>
      <select name="depannage">
        {% for value, label in depannage_options.items() %}
        <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>
    </label>
    <label>
      <span>Astreinte</span>
      <select name="astreinte">
        {% for value, label in astreinte_options.items() %}
        <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>
    </label>
    <label>
      <span>Tags</span>
      <input name="tags" placeholder="Ex: premium, 2024" />
    </label>
    <label>
      <span>Statut</span>
      <select name="status">
        {% for value, label in status_options.items() %}
        <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>
    </label>
    <div class="form-actions full">
      <button class="btn primary" type="submit">Ajouter</button>
    </div>
  </form>
</section>
{% endblock %}
