{% extends "base.html" %}
{% from "_ui_macros.html" import card_shell, form_label, form_control, form_select, form_panel %}
{% block title %}T√¢ches ‚Äî CRM Local{% endblock %}
{% block page_eyebrow %}Automatisations n8n{% endblock %}
{% block page_title %}T√¢ches & envois rapides{% endblock %}
{% block page_subtitle %}Centralisez vos t√©l√©versements PDF et MP3, d√©clenchez vos webhooks n8n et acc√©dez aux formulaires op√©rationnels depuis une m√™me vue.{% endblock %}
{% block main_classes %}space-y-8{% endblock %}
{% block head_extra %}
  <style>
    .upload-card { transition: border-color 0.2s ease, transform 0.2s ease; }
    .upload-card:hover { transform: translateY(-1px); }
    .pill-icon { display: inline-flex; align-items: center; gap: 0.35rem; }
  </style>
{% endblock %}
{% block content %}
  <section class="{{ card_shell('space-y-6') }}">
    <div class="flex flex-wrap items-center justify-between gap-4">
      <div class="space-y-1">
        <p class="{{ form_label('!text-indigo-600 dark:!text-indigo-200') }}">Actions rapides</p>
        <p class="text-base text-slate-700 dark:text-slate-300">D√©clenchez vos workflows n8n ou ouvrez les formulaires d√©di√©s.</p>
      </div>
      <div class="rounded-full border border-indigo-200 bg-indigo-50 px-4 py-1 text-xs font-semibold uppercase tracking-[0.35em] text-indigo-700 dark:border-indigo-400/40 dark:bg-indigo-500/10 dark:text-indigo-100">Multi-fichiers</div>
    </div>
    <div class="flex flex-wrap gap-3">
      <button id="btnUpload1" type="button" class="inline-flex items-center gap-2 rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-800 shadow-sm transition hover:-translate-y-0.5 hover:border-indigo-300 hover:bg-indigo-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-300 dark:border-white/10 dark:bg-white/5 dark:text-white dark:hover:border-indigo-300/60 dark:hover:bg-indigo-500/10">üìÑ T√©l√©verser PDF ‚Üí Rangement d'un rapport S/T</button>
      <button id="btnUpload2" type="button" class="inline-flex items-center gap-2 rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-800 shadow-sm transition hover:-translate-y-0.5 hover:border-indigo-300 hover:bg-indigo-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-300 dark:border-white/10 dark:bg-white/5 dark:text-white dark:hover:border-indigo-300/60 dark:hover:bg-indigo-500/10">üìë T√©l√©verser PDF ‚Üí R√©gularisation d'une DI</button>
      <button id="btnUploadCSTS" type="button" class="inline-flex items-center gap-2 rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-800 shadow-sm transition hover:-translate-y-0.5 hover:border-indigo-300 hover:bg-indigo-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-300 dark:border-white/10 dark:bg-white/5 dark:text-white dark:hover:border-indigo-300/60 dark:hover:bg-indigo-500/10">üßæ T√©l√©verser PDF ‚Üí Cr√©ation d'un CSTS</button>
      <button id="btnUploadMP3" type="button" class="inline-flex items-center gap-2 rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm font-semibold text-slate-800 shadow-sm transition hover:-translate-y-0.5 hover:border-indigo-300 hover:bg-indigo-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-300 dark:border-white/10 dark:bg-white/5 dark:text-white dark:hover:border-indigo-300/60 dark:hover:bg-indigo-500/10">üé§ Soumettre un fichier MP3 ‚Üí Transcription</button>
      <a href="https://forms.monday.com/forms/f2ad375540d46b0472e61808a03eb02e?r=euc1" target="_blank" class="inline-flex items-center gap-2 rounded-2xl border border-indigo-200 bg-indigo-50 px-4 py-3 text-sm font-semibold text-indigo-700 shadow-sm transition hover:-translate-y-0.5 hover:border-indigo-300 hover:bg-indigo-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-300 dark:border-indigo-400/40 dark:bg-indigo-500/10 dark:text-indigo-100 dark:hover:bg-indigo-400/10">üì¶ Demande de mat√©riel</a>
      <a href="https://wkf.ms/40kXh9x?priority_1=" target="_blank" class="inline-flex items-center gap-2 rounded-2xl border border-indigo-200 bg-indigo-50 px-4 py-3 text-sm font-semibold text-indigo-700 shadow-sm transition hover:-translate-y-0.5 hover:border-indigo-300 hover:bg-indigo-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-300 dark:border-indigo-400/40 dark:bg-indigo-500/10 dark:text-indigo-100 dark:hover:bg-indigo-400/10">üìù Demande DC4</a>
      <a href="https://wkf.ms/3GRfc0O" target="_blank" class="inline-flex items-center gap-2 rounded-2xl border border-indigo-200 bg-indigo-50 px-4 py-3 text-sm font-semibold text-indigo-700 shadow-sm transition hover:-translate-y-0.5 hover:border-indigo-300 hover:bg-indigo-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-300 dark:border-indigo-400/40 dark:bg-indigo-500/10 dark:text-indigo-100 dark:hover:bg-indigo-400/10">üßæ Demande CSTS (-15k‚Ç¨)</a>
    </div>
    <div class="rounded-2xl border border-slate-200 bg-slate-50/60 px-4 py-3 text-sm text-slate-600 dark:border-white/10 dark:bg-white/5 dark:text-slate-200">
      <p class="flex items-center gap-2"><span aria-hidden="true">‚ÑπÔ∏è</span> Chaque envoi est limit√© √† 25 Mo. Les r√©ponses des webhooks sont affich√©es dans l'historique ci-dessous.</p>
    </div>
  </section>

  <section id="cstsPanel" class="{{ card_shell('space-y-6') }} hidden">
    <div class="flex flex-wrap items-center justify-between gap-4">
      <div class="space-y-1">
        <p class="{{ form_label('!text-rose-600 dark:!text-rose-200') }}">Cr√©ation d'un CSTS</p>
        <p class="text-base text-slate-700 dark:text-slate-200">Renseignez les informations cl√©s puis envoyez le PDF vers le workflow n8n.</p>
      </div>
      <button id="cstsReset" type="button" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:border-slate-300 hover:bg-slate-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-200 dark:border-white/10 dark:bg-white/5 dark:text-white dark:hover:bg-white/10">R√©initialiser / Masquer</button>
    </div>

    <div class="{{ form_panel('gap-6') }}">
      <div class="grid gap-4 md:grid-cols-2">
        <label class="space-y-2">
          <span class="{{ form_label() }}">PDF offre de prix (S/T) *</span>
          <input id="cstsFile" class="{{ form_control() }}" type="file" accept="application/pdf" />
        </label>
        <label class="space-y-2">
          <span class="{{ form_label() }}">Responsable d'affaire *</span>
          <select id="cstsResp" class="{{ form_select() }}">
            <option value="">‚Äî S√©lectionner ‚Äî</option>
            <option>Sylvain LOZA</option>
            <option>Corentin DENYS</option>
            <option>J√©r√©my GONZALEZ</option>
            <option>David GEHIN</option>
            <option>Christophe BOYER</option>
            <option>Loic MARIE-SAINTE</option>
          </select>
        </label>
      </div>
      <div class="grid gap-4 md:grid-cols-3">
        <label class="space-y-2">
          <span class="{{ form_label() }}">Date d√©but *</span>
          <input id="cstsStart" class="{{ form_control() }}" type="date" />
        </label>
        <label class="space-y-2">
          <span class="{{ form_label() }}">Date fin *</span>
          <input id="cstsEnd" class="{{ form_control() }}" type="date" />
        </label>
        <label class="space-y-2">
          <span class="{{ form_label() }}">Code affaire *</span>
          <input id="cstsCode" class="{{ form_control() }}" type="text" placeholder="Ex: D17-XXXX" />
        </label>
      </div>
      <label class="space-y-2">
        <span class="{{ form_label() }}">Mail de contact S/T (optionnel)</span>
        <input id="cstsMail" class="{{ form_control() }}" type="email" placeholder="exemple@domaine.fr" />
      </label>
      <div class="flex flex-wrap items-center gap-3">
        <button id="cstsSubmit" type="button" class="inline-flex items-center gap-2 rounded-full border border-indigo-200 bg-indigo-500/10 px-6 py-3 text-sm font-semibold uppercase tracking-[0.25em] text-indigo-700 transition hover:bg-indigo-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-200 dark:border-indigo-400/40 dark:bg-indigo-500/10 dark:text-indigo-100 dark:hover:bg-indigo-400/20">Cr√©er le CSTS</button>
        <p class="text-sm text-slate-600 dark:text-slate-300">Le PDF est envoy√© avec les m√©tadonn√©es renseign√©es.</p>
      </div>
    </div>
  </section>

  <section class="{{ card_shell('space-y-4') }}">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>
        <p class="{{ form_label() }}">Historique des envois</p>
        <p class="text-base text-slate-700 dark:text-slate-300">Suivez les statuts, consultez les r√©ponses et relancez en cas d'√©chec.</p>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        <div class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-300">
          <span class="h-2 w-2 rounded-full bg-emerald-500"></span> Succ√®s
          <span class="h-2 w-2 rounded-full bg-amber-500"></span> En cours
          <span class="h-2 w-2 rounded-full bg-rose-500"></span> √âchec
        </div>
        <button id="clearHistory" type="button" class="rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 transition hover:bg-slate-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-200 dark:border-white/10 dark:bg-white/5 dark:text-white dark:hover:bg-white/10">Vider l'historique</button>
      </div>
    </div>
    <div id="uploads" class="grid gap-3 md:grid-cols-2 xl:grid-cols-3"></div>
  </section>

  <input id="fileInput1" type="file" accept="application/pdf" class="hidden" multiple />
  <input id="fileInput2" type="file" accept="application/pdf" class="hidden" multiple />
  <input id="fileInputMP3" type="file" accept="audio/mpeg,audio/mp3" class="hidden" multiple />

  <script>
    const WEBHOOK_URL_1 = "https://n8n.srv947303.hstgr.cloud/webhook/50a1f768-40ec-4886-a38a-e42c98e07b9f";
    const WEBHOOK_URL_2 = "https://n8n.srv947303.hstgr.cloud/webhook/8057a176-0940-4b5f-b461-401831223a4a";
    const WEBHOOK_URL_MP3 = "";
    const WEBHOOK_URL_CSTS = "https://n8n.srv947303.hstgr.cloud/webhook/c8760a79-7ab1-42cc-974a-88c728f418f2";
    const MAX_SIZE_MB = 25;
    const HISTORY_KEY = 'tachesUploadHistory';
    const HISTORY_LIMIT = 30;

    const btnUpload1 = document.getElementById('btnUpload1');
    const btnUpload2 = document.getElementById('btnUpload2');
    const btnUploadMP3 = document.getElementById('btnUploadMP3');
    const btnUploadCSTS = document.getElementById('btnUploadCSTS');

    const fileInput1 = document.getElementById('fileInput1');
    const fileInput2 = document.getElementById('fileInput2');
    const fileInputMP3 = document.getElementById('fileInputMP3');

    const cstsPanel = document.getElementById('cstsPanel');
    const cstsFile = document.getElementById('cstsFile');
    const cstsResp = document.getElementById('cstsResp');
    const cstsStart = document.getElementById('cstsStart');
    const cstsEnd = document.getElementById('cstsEnd');
    const cstsCode = document.getElementById('cstsCode');
    const cstsMail = document.getElementById('cstsMail');
    const cstsSubmit = document.getElementById('cstsSubmit');
    const cstsReset = document.getElementById('cstsReset');

    const uploads = document.getElementById('uploads');
    const clearHistory = document.getElementById('clearHistory');

    const validationMessages = {
      missingFile: 'Aucun fichier s√©lectionn√©.',
      wrongType: (type, accepted) => `Type invalide (${type || 'inconnu'}). Types accept√©s : ${accepted.join(', ')}.`,
      tooLarge: (size, limit) => `Taille ${size.toFixed(1)} Mo > limite ${limit} Mo.`,
      missingWebhook: 'Webhook non configur√© pour cette action.'
    };

    const navigationAbortController = new AbortController();
    const unloadWarning = "Un envoi est en cours. Quitter la page annulera l'op√©ration.";
    let isUnloading = false;
    let activeUploads = 0;

    function incrementUploads() {
      activeUploads += 1;
    }

    function decrementUploads() {
      activeUploads = Math.max(0, activeUploads - 1);
    }

    window.addEventListener('beforeunload', (event) => {
      if (activeUploads > 0) {
        event.preventDefault();
        event.returnValue = unloadWarning;
        return unloadWarning;
      }
      isUnloading = true;
    });

    window.addEventListener('unload', () => {
      isUnloading = true;
      navigationAbortController.abort();
    });

    function makeId() {
      if (typeof crypto?.randomUUID === 'function') return crypto.randomUUID();
      return `upl-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 8)}`;
    }

    function loadHistory() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (error) {
        console.warn('Impossible de charger l\'historique', error);
        return [];
      }
    }

    function saveHistory(entries) {
      try {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(entries.slice(0, HISTORY_LIMIT)));
      } catch (error) {
        console.warn('Impossible de sauvegarder l\'historique', error);
      }
    }

    function upsertHistory(entry) {
      const current = loadHistory();
      const filtered = current.filter((item) => item.id !== entry.id);
      filtered.unshift(entry);
      saveHistory(filtered);
    }

    function clearHistoryEntries() {
      try {
        localStorage.removeItem(HISTORY_KEY);
      } catch (error) {
        console.warn("Impossible de nettoyer l'historique", error);
      }
      uploads.innerHTML = '';
    }

    function validateFile(file, types, maxMB) {
      if (!file) return { ok: false, reason: validationMessages.missingFile };
      const accepted = Array.isArray(types) ? types : [types];
      if (!accepted.includes(file.type)) {
        return { ok: false, reason: validationMessages.wrongType(file.type, accepted) };
      }
      const sizeMB = file.size / (1024 * 1024);
      if (sizeMB > maxMB) {
        return { ok: false, reason: validationMessages.tooLarge(sizeMB, maxMB) };
      }
      return { ok: true };
    }

    function createUploadCard(file, savedEntry) {
      const entry = savedEntry || {
        id: makeId(),
        name: file?.name || 'Fichier',
        size: file?.size || 0,
        type: file?.type || '',
        status: 'pending',
        statusLabel: 'Envoi‚Ä¶',
        response: '',
        date: Date.now(),
      };

      const card = document.createElement('article');
      card.className = 'upload-card rounded-2xl border border-slate-200/80 bg-white/80 p-4 shadow-sm dark:border-white/10 dark:bg-white/5';

      const head = document.createElement('div');
      head.className = 'flex items-start justify-between gap-3';

      const meta = document.createElement('div');
      meta.className = 'min-w-0 space-y-1';
      const title = document.createElement('p');
      title.className = 'truncate text-sm font-semibold text-slate-900 dark:text-white';
      title.textContent = entry.name;
      const size = document.createElement('p');
      size.className = 'text-xs text-slate-500 dark:text-slate-300';
      size.textContent = `${(entry.size / 1024 / 1024).toFixed(2)} Mo`;
      meta.append(title, size);

      const pill = document.createElement('span');
      pill.className = 'pill-icon inline-flex items-center gap-2 rounded-full border border-amber-200 bg-amber-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.25em] text-amber-700 dark:border-amber-400/40 dark:bg-amber-500/10 dark:text-amber-100';
      pill.innerHTML = '<span class="h-3.5 w-3.5 animate-spin rounded-full border-2 border-amber-400 border-r-transparent"></span><span>Envoi‚Ä¶</span>';

      head.append(meta, pill);

      const pre = document.createElement('pre');
      pre.className = 'mt-3 hidden max-h-48 overflow-auto rounded-xl border border-slate-200 bg-slate-50 p-3 text-xs text-slate-700 dark:border-white/10 dark:bg-midnight-800/60 dark:text-slate-200';

      const actions = document.createElement('div');
      actions.className = 'mt-3 flex flex-wrap items-center gap-2';

      const copy = document.createElement('button');
      copy.type = 'button';
      copy.className = 'hidden rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 transition hover:bg-slate-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-200 dark:border-white/10 dark:bg-white/5 dark:text-white dark:hover:bg-white/10';
      copy.textContent = 'Copier';
      copy.onclick = async () => {
        await navigator.clipboard.writeText(pre.textContent);
        copy.textContent = 'Copi√© !';
        setTimeout(() => (copy.textContent = 'Copier'), 1200);
      };

      const retry = document.createElement('button');
      retry.type = 'button';
      retry.className = 'hidden rounded-full border border-rose-200 bg-rose-50 px-3 py-1.5 text-xs font-semibold text-rose-700 transition hover:bg-rose-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-rose-200 dark:border-rose-400/40 dark:bg-rose-500/10 dark:text-rose-100';
      retry.textContent = 'R√©essayer';

      actions.append(copy, retry);
      card.append(head, pre, actions);
      uploads.prepend(card);

      function setPending(label) {
        entry.status = 'pending';
        entry.statusLabel = label;
        upsertHistory(entry);
        pill.className = 'pill-icon inline-flex items-center gap-2 rounded-full border border-amber-200 bg-amber-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.25em] text-amber-700 dark:border-amber-400/40 dark:bg-amber-500/10 dark:text-amber-100';
        pill.innerHTML = `<span class="h-3.5 w-3.5 animate-spin rounded-full border-2 border-amber-400 border-r-transparent"></span><span>${label}</span>`;
      }

      function setOk(text) {
        entry.status = 'ok';
        entry.statusLabel = text;
        upsertHistory(entry);
        pill.className = 'pill-icon inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.25em] text-emerald-700 dark:border-emerald-400/40 dark:bg-emerald-500/10 dark:text-emerald-100';
        pill.textContent = text;
        retry.classList.add('hidden');
      }

      function setErr(text) {
        entry.status = 'error';
        entry.statusLabel = text;
        upsertHistory(entry);
        pill.className = 'pill-icon inline-flex items-center gap-2 rounded-full border border-rose-200 bg-rose-50 px-3 py-1 text-xs font-semibold uppercase tracking-[0.25em] text-rose-700 dark:border-rose-400/40 dark:bg-rose-500/10 dark:text-rose-100';
        pill.textContent = text;
      }

      function showResponse(text) {
        entry.response = text;
        upsertHistory(entry);
        pre.textContent = text || 'Aucune r√©ponse.';
        pre.classList.remove('hidden');
        copy.classList.remove('hidden');
      }

      function setRetry(handler) {
        retry.onclick = handler;
        retry.classList.remove('hidden');
      }

      function restoreState() {
        if (entry.response) {
          pre.textContent = entry.response;
          pre.classList.remove('hidden');
          copy.classList.remove('hidden');
        }
        if (entry.status === 'ok') {
          setOk(entry.statusLabel || 'OK');
        } else if (entry.status === 'error') {
          setErr(entry.statusLabel || 'Erreur');
        } else {
          setPending(entry.statusLabel || 'Envoi‚Ä¶');
        }
      }

      restoreState();

      return {
        entry,
        setPending,
        setOk,
        setErr,
        showResponse,
        setRetry,
      };
    }

    async function uploadToWebhook(file, webhookUrl, payload = {}) {
      if (!webhookUrl) {
        throw new Error(validationMessages.missingWebhook);
      }
      const form = new FormData();
      form.append('file', file, file.name);
      form.append('fileName', file.name);
      form.append('fileSize', String(file.size));
      form.append('mimeType', file.type);
      Object.entries(payload).forEach(([key, value]) => {
        if (value !== undefined && value !== null && String(value).trim() !== '') {
          form.append(key, value);
        }
      });

      const res = await fetch(webhookUrl, {
        method: 'POST',
        body: form,
        signal: navigationAbortController.signal,
      });
      const contentType = (res.headers.get('content-type') || '').toLowerCase();
      let bodyText = '';
      try {
        if (contentType.includes('application/json')) {
          const json = await res.json();
          if (json && typeof json === 'object') {
            if (typeof json.markdown === 'string') bodyText = json.markdown;
            else if (typeof json.text === 'string') bodyText = json.text;
            else bodyText = JSON.stringify(json, null, 2);
          } else {
            bodyText = String(json);
          }
        } else {
          bodyText = await res.text();
        }
      } catch (err) {
        bodyText = await res.text().catch(() => '');
      }
      if (!res.ok) {
        throw new Error(bodyText || `HTTP ${res.status}`);
      }
      return { status: res.status, bodyText };
    }

    async function processFiles(files, webhookUrl, types) {
      const list = Array.from(files);
      await Promise.all(list.map(async (file) => {
        const check = validateFile(file, types, MAX_SIZE_MB);
        const ui = createUploadCard(file);
        if (!check.ok) {
          ui.setErr('Erreur');
          ui.showResponse(check.reason);
          return;
        }

        const run = async () => {
          incrementUploads();
          try {
            ui.setPending('Traitement‚Ä¶');
            const { status, bodyText } = await uploadToWebhook(file, webhookUrl);
            ui.setOk(`OK ${status}`);
            ui.showResponse(bodyText);
          } catch (error) {
            if (isUnloading || error?.name === 'AbortError') {
              ui.setErr('Interrompu');
              ui.showResponse('Envoi interrompu (rafra√Æchissement ou navigation).');
              return;
            }
            ui.setErr('√âchec');
            ui.showResponse(String(error.message || error));
            ui.setRetry(run);
          } finally {
            decrementUploads();
          }
        };

        await run();
      }));
    }

    function wireButton(button, input, webhookUrl, types) {
      button?.addEventListener('click', () => {
        input.onchange = async () => {
          const { files } = input;
          if (!files || files.length === 0) return;
          await processFiles(files, webhookUrl, types);
          input.value = '';
        };
        input.click();
      });
    }

    wireButton(btnUpload1, fileInput1, WEBHOOK_URL_1, 'application/pdf');
    wireButton(btnUpload2, fileInput2, WEBHOOK_URL_2, 'application/pdf');
    wireButton(btnUploadMP3, fileInputMP3, WEBHOOK_URL_MP3, ['audio/mpeg', 'audio/mp3']);

    btnUploadCSTS?.addEventListener('click', () => {
      cstsPanel.classList.toggle('hidden');
    });

    cstsReset?.addEventListener('click', () => {
      cstsFile.value = '';
      cstsResp.value = '';
      cstsStart.value = '';
      cstsEnd.value = '';
      cstsCode.value = '';
      cstsMail.value = '';
      cstsPanel.classList.add('hidden');
    });

    cstsSubmit?.addEventListener('click', async () => {
      const file = cstsFile.files && cstsFile.files[0];
      const check = validateFile(file, 'application/pdf', MAX_SIZE_MB);
      if (!check.ok) {
        alert(check.reason);
        return;
      }
      if (!cstsResp.value) {
        alert("Veuillez s√©lectionner un responsable d'affaire.");
        return;
      }
      if (!cstsStart.value || !cstsEnd.value) {
        alert('Veuillez renseigner les dates d√©but et fin.');
        return;
      }
      if (cstsEnd.value < cstsStart.value) {
        alert('La date de fin doit √™tre post√©rieure ou √©gale √† la date de d√©but.');
        return;
      }
      if (!cstsCode.value.trim()) {
        alert('Veuillez renseigner le code affaire.');
        return;
      }

      const ui = createUploadCard(file);
      const payload = {
        action: 'creation_csts',
        responsableAffaire: cstsResp.value,
        dateDebut: cstsStart.value,
        dateFin: cstsEnd.value,
        codeAffaire: cstsCode.value.trim(),
        emailContactST: cstsMail.value.trim(),
      };

      const run = async () => {
        try {
          ui.setPending('Cr√©ation CSTS‚Ä¶');
          const { status, bodyText } = await uploadToWebhook(file, WEBHOOK_URL_CSTS, payload);
          ui.setOk(`OK ${status}`);
          ui.showResponse(bodyText);
          cstsReset.click();
        } catch (error) {
          if (isUnloading || error?.name === 'AbortError') {
            ui.setErr('Interrompu');
            ui.showResponse('Envoi interrompu (rafra√Æchissement ou navigation).');
            return;
          }
          ui.setErr('√âchec');
          ui.showResponse(String(error.message || error));
          ui.setRetry(run);
        }
      };

      await run();
    });

    function renderHistory() {
      const history = loadHistory();
      history.forEach((entry) => createUploadCard(null, entry));
    }

    clearHistory?.addEventListener('click', () => {
      const shouldClear = confirm("Voulez-vous vraiment vider l'historique des envois ?");
      if (!shouldClear) return;
      clearHistoryEntries();
    });

    renderHistory();
  </script>
{% endblock %}
