<script>
  (function() {
    const initForm = (form) => {
      if (!form || form.dataset.enhanced === 'true') return;
      const prestationSelect = form.querySelector('[data-prestation-select]');
      const budgetOutput = form.querySelector('[data-budget-output]');
      const frequencySelect = form.querySelector('[data-frequency-select]');
      const customIntervalField = form.querySelector('[data-custom-interval-field]');
      const customIntervalInput = customIntervalField?.querySelector('[data-custom-interval-input]');
      const customIntervalUnit = customIntervalField?.querySelector('[data-custom-interval-unit]');
      const customIntervalValue = frequencySelect?.dataset.customIntervalValue;
      const weekField = form.querySelector('[data-week-field]');
      const weekInput = weekField?.querySelector('input');
      const clientSelect = form.querySelector('[data-client-select]');
      const clientOutput = form.parentElement?.querySelector('[data-client-output]');

      const updateBudget = () => {
        if (!prestationSelect || !budgetOutput) return;
        const selected = prestationSelect.options[prestationSelect.selectedIndex];
        budgetOutput.value = selected?.dataset?.budgetCode || '';
      };

      const toggleWeekField = () => {
        if (!frequencySelect || !weekField || !weekInput) return;
        const isPonctual = frequencySelect.value === 'prestation_ponctuelle';
        weekField.classList.toggle('hidden', !isPonctual);
        weekInput.disabled = !isPonctual;
        if (!isPonctual) {
          weekInput.value = '';
        }
      };

      const toggleCustomInterval = () => {
        if (!frequencySelect || !customIntervalField || !customIntervalInput || !customIntervalUnit || !customIntervalValue) return;
        const isCustom = frequencySelect.value === customIntervalValue;
        customIntervalField.classList.toggle('hidden', !isCustom);
        customIntervalInput.disabled = !isCustom;
        customIntervalInput.required = isCustom;
        customIntervalUnit.disabled = !isCustom;
        customIntervalUnit.required = isCustom;
        if (!isCustom) {
          customIntervalInput.value = '';
        }
      };

      const updateClientSummary = () => {
        if (!clientSelect || !clientOutput) return;
        const selected = clientSelect.options[clientSelect.selectedIndex];
        const label = selected?.textContent?.replace(/\s+/g, ' ').trim();
        clientOutput.textContent = label || 'â€”';
      };

      prestationSelect?.addEventListener('change', updateBudget);
      frequencySelect?.addEventListener('change', () => {
        toggleWeekField();
        toggleCustomInterval();
      });
      clientSelect?.addEventListener('change', updateClientSummary);

      updateBudget();
      toggleWeekField();
      toggleCustomInterval();
      updateClientSummary();
      form.dataset.enhanced = 'true';
    };

    const enhanceAll = () => {
      document.querySelectorAll('.subcontract-form').forEach(initForm);
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', enhanceAll, { once: true });
    } else {
      enhanceAll();
    }

    document.body?.addEventListener('htmx:afterSwap', enhanceAll);
  })();
</script>
